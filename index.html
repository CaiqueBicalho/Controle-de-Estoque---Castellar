<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estoque Castellar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18.3.1/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#FAF7F2;--bg2:#F3EDE3;--card:#fff;--border:#E8DDD0;
      --text:#1C1410;--text2:#6B5B4E;--text3:#9E8E82;
      --primary:#5C3D2E;--primary-fg:#FAF7F2;
      --green:#2D6A4F;--red:#C0392B;--warn:#E67E22;
      --sh:0 1px 3px rgba(92,61,46,.08);--sh-md:0 4px 16px rgba(92,61,46,.14);
      --r:12px;--rs:8px;
    }
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}
    h1,h2,h3{font-family:'Fraunces',serif}

    /* Layout */
    .shell{display:flex;flex-direction:column;min-height:100vh}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 1rem;height:56px;display:flex;align-items:center;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:34px;height:34px;border-radius:10px;background:var(--primary);display:flex;align-items:center;justify-content:center}
    .logo-name{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:600}
    .body{display:flex;flex:1}
    .sidebar{width:220px;flex-shrink:0;border-right:1px solid var(--border);background:var(--card);padding:1rem .75rem;display:flex;flex-direction:column;gap:2px}
    @media(max-width:768px){.sidebar{display:none}}
    .sb{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--rs);font-size:.875rem;font-weight:500;color:var(--text2);cursor:pointer;border:none;background:none;width:100%;text-align:left;transition:all .15s;font-family:'DM Sans',sans-serif}
    .sb:hover{background:var(--bg);color:var(--text)}
    .sb.on{background:var(--primary);color:var(--primary-fg)}
    .sb.danger{color:var(--red)}
    .sb.danger:hover{background:rgba(192,57,43,.08)}
    .sb-sp{flex:1}
    .sb-u{border-top:1px solid var(--border);padding-top:.75rem;margin-top:.5rem}
    .sb-name{font-size:.85rem;font-weight:600;padding:0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sb-role{font-size:.72rem;color:var(--text3);padding:0 4px;margin-bottom:6px;text-transform:capitalize}
    .main{flex:1;padding:1.25rem 1rem;max-width:860px;margin:0 auto;width:100%}
    @media(min-width:769px){.main{padding:1.5rem 2rem}}
    .bnav{position:sticky;bottom:0;z-index:50;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border-top:1px solid var(--border);display:flex}
    @media(min-width:769px){.bnav{display:none}}
    .bni{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 4px 10px;font-size:.68rem;font-weight:500;color:var(--text3);cursor:pointer;border:none;background:none;transition:color .15s;font-family:'DM Sans',sans-serif}
    .bni.on{color:var(--primary)}

    /* Buttons */
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--rs);font-size:.875rem;font-weight:600;cursor:pointer;border:none;transition:all .15s;white-space:nowrap;font-family:'DM Sans',sans-serif}
    .btn-p{background:var(--primary);color:var(--primary-fg)}
    .btn-p:hover:not(:disabled){background:#4a3024}
    .btn-o{background:transparent;color:var(--text);border:1.5px solid var(--border)}
    .btn-o:hover:not(:disabled){background:var(--bg)}
    .btn-g{background:rgba(45,106,79,.12);color:var(--green);border:1.5px solid rgba(45,106,79,.3)}
    .btn-g:hover:not(:disabled){background:rgba(45,106,79,.2)}
    .btn-r{background:rgba(192,57,43,.12);color:var(--red);border:1.5px solid rgba(192,57,43,.3)}
    .btn-r:hover:not(:disabled){background:rgba(192,57,43,.2)}
    .btn-danger{background:var(--red);color:white}
    .btn-sm{padding:5px 11px;font-size:.8rem}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-full{justify-content:center;width:100%}

    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden}
    .cb{padding:1rem}
    .card-dash{border-style:dashed;background:transparent;box-shadow:none}

    /* Form */
    .input{width:100%;padding:9px 12px;border-radius:var(--rs);border:1.5px solid var(--border);background:var(--card);font-family:'DM Sans',sans-serif;font-size:.9rem;color:var(--text);outline:none;transition:border-color .15s}
    .input:focus{border-color:var(--primary)}
    .input::placeholder{color:var(--text3)}
    .sel{width:100%;padding:9px 32px 9px 12px;border-radius:var(--rs);border:1.5px solid var(--border);background:var(--card);font-family:'DM Sans',sans-serif;font-size:.9rem;color:var(--text);outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239E8E82' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
    .sel:focus{border-color:var(--primary)}
    .lbl{display:block;font-size:.82rem;font-weight:600;color:var(--text2);margin-bottom:5px}
    .fg{margin-bottom:1rem}
    .fgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:480px){.fgrid{grid-template-columns:1fr}}

    /* Badges */
    .badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:100px;font-size:.72rem;font-weight:600;border:1px solid transparent}
    .b-sec{background:var(--bg2);color:var(--text2);border-color:var(--border)}
    .b-green{background:rgba(45,106,79,.12);color:var(--green);border-color:rgba(45,106,79,.3)}
    .b-red{background:rgba(192,57,43,.12);color:var(--red);border-color:rgba(192,57,43,.3)}
    .b-primary{background:rgba(92,61,46,.12);color:var(--primary);border-color:rgba(92,61,46,.3)}
    .b-warn{background:rgba(230,126,34,.12);color:var(--warn);border-color:rgba(230,126,34,.3)}

    /* Modal */
    .overlay{position:fixed;inset:0;z-index:100;background:rgba(28,20,16,.45);display:flex;align-items:center;justify-content:center;padding:1rem;animation:fi .15s ease}
    .modal{background:var(--card);border-radius:var(--r);box-shadow:var(--sh-md);width:100%;max-width:440px;animation:su .2s ease;max-height:90vh;overflow-y:auto}
    .mh{padding:1.25rem 1.25rem 0}
    .mt{font-size:1.1rem;font-family:'Fraunces',serif;font-weight:600}
    .mb{padding:1rem 1.25rem}
    .mf{padding:0 1.25rem 1.25rem;display:flex;gap:8px;justify-content:flex-end}

    /* Toasts */
    .tc{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none}
    @media(min-width:769px){.tc{bottom:20px}}
    .toast{background:var(--text);color:var(--bg);padding:10px 20px;border-radius:var(--rs);font-size:.875rem;font-weight:500;box-shadow:var(--sh-md);animation:su .2s ease;max-width:320px;text-align:center}
    .toast.ok{background:var(--green);color:#fff}
    .toast.err{background:var(--red);color:#fff}

    /* Pages */
    .ph{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;gap:8px}
    .pt{font-size:1.4rem;font-family:'Fraunces',serif;font-weight:700}
    .sy>*+*{margin-top:8px}
    .sy2>*+*{margin-top:6px}
    .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem 1rem;text-align:center;gap:12px;color:var(--text3)}

    /* Category section */
    .cat-header{display:flex;align-items:center;gap:10px;padding:.6rem 0 .4rem;margin-top:.75rem}
    .cat-title{font-size:1rem;font-family:'Fraunces',serif;font-weight:600;color:var(--text2)}
    .cat-line{flex:1;height:1px;background:var(--border)}
    .cat-count{font-size:.72rem;color:var(--text3);font-weight:500}

    /* Product card */
    .prod-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--sh);overflow:hidden}
    .prod-header{padding:.875rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer;user-select:none}
    .prod-header:hover{background:rgba(92,61,46,.02)}
    .prod-name{font-weight:600;font-size:.95rem}
    .prod-meta{font-size:.75rem;color:var(--text3);margin-top:2px}
    .prod-stock-total{font-size:1.4rem;font-weight:700;text-align:right;line-height:1}
    .prod-stock-label{font-size:.65rem;color:var(--text3);text-align:right}
    .chevron{transition:transform .2s;color:var(--text3)}
    .chevron.open{transform:rotate(180deg)}

    /* Variation rows */
    .vars{border-top:1px solid var(--border)}
    .var-row{padding:.65rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .var-row:not(:last-child){border-bottom:1px solid var(--bg2)}
    .var-name{font-size:.875rem;font-weight:500}
    .var-stock{font-size:1.1rem;font-weight:700}
    .var-actions{display:flex;gap:6px}

    /* Reports */
    .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
    .stat-card{padding:1rem;display:flex;align-items:center;gap:12px}
    .stat-icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .stat-lbl{font-size:.72rem;color:var(--text3);margin-bottom:2px}
    .stat-val{font-size:1.6rem;font-weight:700}
    .mov-row{padding:.7rem 1rem}
    .mov-row:not(:last-child){border-bottom:1px solid var(--border)}

    /* Login / Pending */
    .center-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;background:radial-gradient(ellipse at 60% 20%,rgba(92,61,46,.06) 0%,transparent 60%),var(--bg)}
    .login-card{width:100%;max-width:360px;background:var(--card);border-radius:16px;border:1px solid var(--border);box-shadow:var(--sh-md);padding:2rem}
    .login-icon{width:52px;height:52px;border-radius:14px;background:var(--primary);display:flex;align-items:center;justify-content:center;margin:0 auto 1.25rem}
    .login-title{font-size:1.5rem;font-family:'Fraunces',serif;font-weight:700;text-align:center}
    .login-sub{text-align:center;color:var(--text3);font-size:.875rem;margin-top:4px;margin-bottom:1.5rem}
    .err-box{background:rgba(192,57,43,.08);border:1px solid rgba(192,57,43,.3);color:var(--red);padding:8px 12px;border-radius:var(--rs);font-size:.85rem;margin-bottom:12px}
    .pending-icon{width:64px;height:64px;border-radius:16px;background:rgba(230,126,34,.12);display:flex;align-items:center;justify-content:center;margin:0 auto 1.25rem;color:var(--warn)}
    .pending-id{margin-top:1.5rem;font-size:.72rem;color:var(--text3);background:var(--bg2);padding:8px 12px;border-radius:8px;word-break:break-all;font-family:monospace}

    /* Utils */
    .loading{text-align:center;padding:3rem;color:var(--text3);animation:pulse 1.5s ease infinite;font-family:'Fraunces',serif}
    .ai{animation:su .3s ease}
    .back-btn{display:inline-flex;align-items:center;gap:6px;color:var(--text3);font-size:.875rem;cursor:pointer;border:none;background:none;margin-bottom:1rem;padding:0;font-family:'DM Sans',sans-serif}
    .back-btn:hover{color:var(--text)}
    .divider{height:1px;background:var(--border);margin:.75rem 0}
    .row{display:flex;align-items:center;gap:8px}
    .flex1{flex:1}
    .trunc{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    @keyframes fi{from{opacity:0}to{opacity:1}}
    @keyframes su{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  </style>
</head>
<body>
<div id="root"><div class="loading" style="padding-top:40vh">Carregando...</div></div>
<div class="tc" id="toasts"></div>

<script>
window.addEventListener('load', function() {
  if (!window.React || !window.ReactDOM || !window.supabase) {
    document.getElementById('root').innerHTML =
      '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:16px;padding:2rem;text-align:center">' +
      '<p style="font-size:1rem;color:#C0392B;font-weight:600">Erro ao carregar bibliotecas</p>' +
      '<p style="font-size:.85rem;color:#6B5B4E">Verifique sua conexão com a internet e recarregue.</p>' +
      '<button onclick="location.reload()" style="padding:8px 20px;background:#5C3D2E;color:white;border:none;border-radius:8px;cursor:pointer">Recarregar</button>' +
      '</div>';
    return;
  }
  run();
});

function run() {
  var R = window.React;
  var RD = window.ReactDOM;
  var h = R.createElement;
  var us = R.useState;
  var ue = R.useEffect;
  var uc = R.useContext;
  var cc = R.createContext;
  var Frag = R.Fragment;
  var sb = window.supabase.createClient(
    'https://kskmgyuocnsebwgdgeiu.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtza21neXVvY25zZWJ3Z2RnZWl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNjIwMzksImV4cCI6MjA4NjkzODAzOX0.Bzqpz3dPVoSaP2YA8pJimt5Jf73oxcll7-Y2Qc8ctp0'
  );
  var OWNER = 'bicalho.ca@gmail.com';

  // ── TOAST ──────────────────────────────────────────────────────────
  function toast(msg, type) {
    var el = document.createElement('div');
    el.className = 'toast' + (type ? ' ' + type : '');
    el.textContent = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(function() { try { el.remove(); } catch(e){} }, 3500);
  }

  // ── ICONS (SVG inline) ─────────────────────────────────────────────
  var I = {
    pkg:'<path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>',
    box:'<path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>',
    chart:'<line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/>',
    users:'<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
    plus:'<path d="M5 12h14"/><path d="M12 5v14"/>',
    minus:'<path d="M5 12h14"/>',
    out:'<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>',
    left:'<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
    down:'<path d="M12 5v14"/><path d="m19 12-7 7-7-7"/>',
    up:'<path d="m5 12 7-7 7 7"/><path d="M12 19V5"/>',
    clock:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
    uplus:'<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/>',
    lock:'<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
    ref:'<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>',
    chev:'<path d="m6 9 6 6 6-6"/>',
    edit:'<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>',
    trash:'<polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/>',
  };
  function Ic(props) {
    var n=props.n, s=props.s||20, c=props.c||'currentColor';
    return h('svg',{xmlns:'http://www.w3.org/2000/svg',width:s,height:s,viewBox:'0 0 24 24',fill:'none',stroke:c,strokeWidth:'2',strokeLinecap:'round',strokeLinejoin:'round',style:{flexShrink:0,display:'inline-block',verticalAlign:'middle'},dangerouslySetInnerHTML:{__html:I[n]||''}});
  }

  // ── AUTH ───────────────────────────────────────────────────────────
  var ACtx = cc(null);
  var useAuth = function() { return uc(ACtx); };

  function AuthProv(props) {
    var _u=us(undefined); var user=_u[0]; var setUser=_u[1];
    var _r=us(null); var role=_r[0]; var setRole=_r[1];
    var _n=us(null); var pname=_n[0]; var setPname=_n[1];

    async function loadRole(u) {
      if (!u) { setRole(null); setPname(null); return; }
      try {
        var isOwner = u.email && u.email.toLowerCase() === OWNER;
        if (isOwner) {
          // Owner sempre gestor — upsert direto
          await sb.from('user_roles').upsert({user_id:u.id,role:'gestor'},{onConflict:'user_id'});
          setRole('gestor');
        } else {
          var {data:rd} = await sb.from('user_roles').select('role').eq('user_id',u.id).maybeSingle();
          setRole(rd ? rd.role : null);
        }
        var {data:pd} = await sb.from('profiles').select('full_name').eq('user_id',u.id).maybeSingle();
        setPname(pd ? pd.full_name : (u.email||''));
      } catch(e) { console.error(e); setRole(null); }
    }

    ue(function(){
      sb.auth.getSession().then(function(res){
        var u = res.data.session ? res.data.session.user : null;
        setUser(u); loadRole(u);
      });
      var sub = sb.auth.onAuthStateChange(function(ev,sess){
        if(ev==='INITIAL_SESSION') return;
        var u = sess ? sess.user : null;
        setUser(u); loadRole(u);
      });
      return function(){ sub.data.subscription.unsubscribe(); };
    },[]);

    async function signIn(email,pw) {
      try {
        var {error} = await sb.auth.signInWithPassword({email:email,password:pw});
        return {error: error ? error.message : null};
      } catch(e) { return {error:'Erro de conexão.'}; }
    }
    async function signOut() { await sb.auth.signOut(); setUser(null); setRole(null); setPname(null); }
    async function refreshRole() { if(user) await loadRole(user); }

    return h(ACtx.Provider,{value:{user,role,pname,signIn,signOut,refreshRole}},props.children);
  }

  // ── MODAL ──────────────────────────────────────────────────────────
  function Modal(props) {
    if(!props.open) return null;
    return h('div',{className:'overlay',onClick:function(e){if(e.target===e.currentTarget)props.onClose();}},
      h('div',{className:'modal'},
        h('div',{className:'mh'},h('h3',{className:'mt'},props.title)),
        h('div',{className:'mb'},props.children),
        props.footer && h('div',{className:'mf'},props.footer)
      )
    );
  }

  // ── LOGIN ──────────────────────────────────────────────────────────
  function Login() {
    var auth = useAuth();
    var _e=us('');var email=_e[0];var setEmail=_e[1];
    var _p=us('');var pw=_p[0];var setPw=_p[1];
    var _er=us('');var err=_er[0];var setErr=_er[1];
    var _b=us(false);var busy=_b[0];var setBusy=_b[1];

    async function submit(e){
      e.preventDefault(); setBusy(true); setErr('');
      var res = await auth.signIn(email,pw);
      if(res.error){
        setErr(res.error.toLowerCase().indexOf('invalid')>=0?'Email ou senha incorretos.':res.error);
        setBusy(false);
      }
    }
    return h('div',{className:'center-wrap'},
      h('div',{className:'login-card ai'},
        h('div',{className:'login-icon'},h(Ic,{n:'pkg',s:24,c:'#FAF7F2'})),
        h('h1',{className:'login-title'},'Castellar Móbile'),
        h('p',{className:'login-sub'},'Gestão de Estoque'),
        h('form',{onSubmit:submit},
          h('div',{className:'fg'},h('label',{className:'lbl'},'Email'),h('input',{className:'input',type:'email',placeholder:'seu@email.com',value:email,onChange:function(e){setEmail(e.target.value);},required:true,autoComplete:'email'})),
          h('div',{className:'fg'},h('label',{className:'lbl'},'Senha'),h('input',{className:'input',type:'password',placeholder:'••••••••',value:pw,onChange:function(e){setPw(e.target.value);},required:true,autoComplete:'current-password'})),
          err && h('div',{className:'err-box'},err),
          h('button',{className:'btn btn-p btn-full',type:'submit',disabled:busy,style:{justifyContent:'center'}},busy?'Entrando...':'Entrar')
        )
      )
    );
  }

  // ── PENDING ────────────────────────────────────────────────────────
  function Pending() {
    var auth = useAuth();
    var _b=us(false);var busy=_b[0];var setBusy=_b[1];
    async function check(){ setBusy(true); await auth.refreshRole(); setBusy(false); }
    return h('div',{className:'center-wrap'},
      h('div',{className:'login-card ai',style:{textAlign:'center'}},
        h('div',{className:'pending-icon',style:{margin:'0 auto 1.25rem'}},h(Ic,{n:'lock',s:28})),
        h('h2',{style:{fontFamily:'Fraunces,serif',fontSize:'1.35rem',fontWeight:700,marginBottom:8}},'Acesso Pendente'),
        h('p',{style:{color:'var(--text2)',fontSize:'.9rem',lineHeight:1.5,marginBottom:20}},'Seu acesso ainda não foi configurado. Peça ao gestor para atribuir seu papel.'),
        h('div',{style:{display:'flex',gap:8,justifyContent:'center',flexWrap:'wrap'}},
          h('button',{className:'btn btn-p btn-sm',onClick:check,disabled:busy,style:{display:'inline-flex',alignItems:'center',gap:6}},h(Ic,{n:'ref',s:14}),busy?'Verificando...':'Verificar acesso'),
          h('button',{className:'btn btn-o btn-sm',onClick:auth.signOut,style:{display:'inline-flex',alignItems:'center',gap:6}},h(Ic,{n:'out',s:14}),'Sair')
        ),
        h('div',{className:'pending-id'},'ID: '+(auth.user?auth.user.id:''))
      )
    );
  }

  // ── PRODUCTS PAGE ──────────────────────────────────────────────────
  var CATS = [
    {id:'sofa',label:'Sofás'},
    {id:'poltrona',label:'Poltronas'},
    {id:'recamier',label:'Recamiers'},
    {id:'puff',label:'Puffs'},
    {id:'outro',label:'Outros'},
  ];
  var CAT_MAP = {};
  CATS.forEach(function(c){CAT_MAP[c.id]=c.label;});

  function Products(props) {
    var goTo = props.goTo;
    var auth = useAuth();
    var canEdit = auth.role==='gestor'||auth.role==='editor';

    var _prods=us([]);var prods=_prods[0];var setProds=_prods[1];
    var _vars=us({});var vars=_vars[0];var setVars=_vars[1]; // {prod_id:[...]}
    var _bal=us({});var bal=_bal[0];var setBal=_bal[1]; // {var_id: stock}
    var _open=us({});var open=_open[0];var setOpen=_open[1]; // {prod_id: bool}
    var _loading=us(true);var loading=_loading[0];var setLoading=_loading[1];
    var _mov=us(null);var mov=_mov[0];var setMov=_mov[1]; // {variation, type}
    var _qty=us('1');var qty=_qty[0];var setQty=_qty[1];
    var _busy=us(false);var busy=_busy[0];var setBusy=_busy[1];

    async function load() {
      var [r1,r2,r3] = await Promise.all([
        sb.from('products').select('*').order('name'),
        sb.from('product_variations').select('*').order('name'),
        sb.from('stock_movements').select('variation_id,product_id,type,quantity'),
      ]);

      var products = r1.data||[];
      var variations = r2.data||[];
      var movements = r3.data||[];

      // If no product_variations table exists, fall back to products as variations
      var hasVarTable = !r2.error;

      var vMap = {}; // prod_id -> variations[]
      var bMap = {}; // var_id or prod_id -> balance

      if(hasVarTable && variations.length>=0) {
        products.forEach(function(p){vMap[p.id]=[];});
        variations.forEach(function(v){
          if(vMap[v.product_id]) vMap[v.product_id].push(v);
          else vMap[v.product_id]=[v];
        });
        // balance by variation_id
        movements.forEach(function(m){
          var key = m.variation_id||m.product_id;
          bMap[key]=(bMap[key]||0)+(m.type==='entrada'?m.quantity:-m.quantity);
        });
      } else {
        // fallback: treat each product as its own variation
        products.forEach(function(p){
          vMap[p.id]=[{id:p.id,product_id:p.id,name:'Padrão',size:p.size,fabric:p.fabric}];
        });
        movements.forEach(function(m){
          var key = m.product_id;
          bMap[key]=(bMap[key]||0)+(m.type==='entrada'?m.quantity:-m.quantity);
        });
      }

      setProds(products);
      setVars(vMap);
      setBal(bMap);
      // default open first category
      var firstOpen = {};
      if(products.length>0) firstOpen[products[0].id]=true;
      setOpen(firstOpen);
      setLoading(false);
    }

    ue(function(){load();;},[]);

    async function doMov(){
      var n=parseInt(qty);
      if(!n||n<=0){toast('Quantidade inválida','err');return;}
      setBusy(true);
      var ins = {type:mov.type,quantity:n,user_id:auth.user.id};
      // If variation has product_id, use variation_id; else use product_id
      if(mov.variation.product_id){
        ins.product_id = mov.variation.product_id;
        ins.variation_id = mov.variation.id !== mov.variation.product_id ? mov.variation.id : null;
      } else {
        ins.product_id = mov.variation.id;
      }
      var {error} = await sb.from('stock_movements').insert(ins);
      setBusy(false);
      if(error){toast('Erro: '+error.message,'err');return;}
      toast(mov.type==='entrada'?'✓ Entrada registrada!':'✓ Saída registrada!','ok');
      setMov(null);setQty('1');
      // refresh balance
      var key = ins.variation_id||ins.product_id;
      var nb = Object.assign({},bal);
      nb[key]=(nb[key]||0)+(mov.type==='entrada'?n:-n);
      setBal(nb);
    }

    if(loading) return h('div',{className:'loading'},'Carregando produtos...');

    // Group by category
    var bycat = {};
    CATS.forEach(function(c){bycat[c.id]=[];});
    prods.forEach(function(p){
      var cat = p.category||'outro';
      if(!bycat[cat]) bycat[cat]=[];
      bycat[cat].push(p);
    });

    var sections = CATS.filter(function(c){return bycat[c.id]&&bycat[c.id].length>0;});

    function totalStock(prodId){
      var pvars = vars[prodId]||[];
      return pvars.reduce(function(s,v){
        var key = v.id!==v.product_id ? v.id : (v.product_id||v.id);
        return s+(bal[key]||0);
      },0);
    }

    function toggleProd(id){
      var nb = Object.assign({},open);
      nb[id]=!nb[id];
      setOpen(nb);
    }

    return h('div',{className:'ai'},
      h('div',{className:'ph'},
        h('h1',{className:'pt'},'Produtos'),
        canEdit && h('button',{className:'btn btn-p btn-sm',onClick:function(){goTo('new-product');},style:{display:'inline-flex',alignItems:'center',gap:6}},h(Ic,{n:'plus',s:14}),'Novo')
      ),
      prods.length===0
        ? h('div',{className:'card card-dash'},h('div',{className:'empty'},h(Ic,{n:'box',s:48}),h('p',null,'Nenhum produto cadastrado'),canEdit&&h('button',{className:'btn btn-o btn-sm',style:{marginTop:4},onClick:function(){goTo('new-product');}},'Cadastrar primeiro produto')))
        : h('div',null,
            sections.map(function(cat){
              var catProds = bycat[cat.id];
              return h('div',{key:cat.id},
                h('div',{className:'cat-header'},
                  h('span',{className:'cat-title'},cat.label),
                  h('span',{className:'cat-count'},catProds.length+' produto'+(catProds.length!==1?'s':'')),
                  h('div',{className:'cat-line'})
                ),
                h('div',{className:'sy2'},
                  catProds.map(function(p){
                    var pvars = vars[p.id]||[];
                    var total = totalStock(p.id);
                    var isOpen = !!open[p.id];
                    return h('div',{key:p.id,className:'prod-card'},
                      h('div',{className:'prod-header',onClick:function(){toggleProd(p.id);}},
                        h('div',{style:{flex:1,minWidth:0}},
                          h('div',{className:'prod-name trunc'},p.name),
                          h('div',{className:'prod-meta'},
                            pvars.length+' variação'+(pvars.length!==1?'ões':'')
                          )
                        ),
                        h('div',{style:{display:'flex',alignItems:'center',gap:12}},
                          h('div',null,
                            h('div',{className:'prod-stock-total',style:{color:total<=0?'var(--red)':'var(--text)'}},total),
                            h('div',{className:'prod-stock-label'},'total')
                          ),
                          h(Ic,{n:'chev',s:18,c:'var(--text3)'})
                        )
                      ),
                      isOpen && h('div',{className:'vars'},
                        pvars.length===0
                          ? h('div',{style:{padding:'1rem',color:'var(--text3)',fontSize:'.85rem',textAlign:'center'}},'Nenhuma variação cadastrada',
                              canEdit&&h('div',null,' ',h('button',{className:'btn btn-o btn-sm',style:{marginTop:8},onClick:function(){goTo('new-variation-'+p.id);}},'+ Variação'))
                            )
                          : pvars.map(function(v){
                              var key = v.id!==v.product_id ? v.id : v.product_id;
                              var stock = bal[key]||0;
                              return h('div',{key:v.id,className:'var-row'},
                                h('div',{style:{flex:1,minWidth:0}},
                                  h('div',{className:'var-name trunc'},v.name||'Padrão'),
                                  (v.size||v.fabric) && h('div',{style:{fontSize:'.72rem',color:'var(--text3)'}},
                                    [v.size&&('Tam: '+v.size), v.fabric&&('Tecido: '+v.fabric)].filter(Boolean).join(' · ')
                                  )
                                ),
                                h('div',{style:{display:'flex',alignItems:'center',gap:10}},
                                  h('span',{className:'var-stock',style:{color:stock<=0?'var(--red)':'var(--text)'}},stock),
                                  canEdit && h('div',{className:'var-actions'},
                                    h('button',{className:'btn btn-g btn-sm',title:'Entrada',onClick:function(){setMov({variation:v,type:'entrada'});setQty('1');}},h(Ic,{n:'plus',s:13})),
                                    h('button',{className:'btn btn-r btn-sm',title:'Saída',onClick:function(){setMov({variation:v,type:'saida'});setQty('1');}},h(Ic,{n:'minus',s:13}))
                                  )
                                )
                              );
                            }),
                        canEdit && h('div',{style:{padding:'.6rem 1rem',borderTop:'1px solid var(--bg2)'}},
                          h('button',{className:'btn btn-o btn-sm',onClick:function(){goTo('new-variation-'+p.id);},style:{display:'inline-flex',alignItems:'center',gap:6}},h(Ic,{n:'plus',s:12}),'Nova Variação')
                        )
                      )
                    );
                  })
                )
              );
            })
          ),
      // Movement modal
      h(Modal,{open:!!mov,onClose:function(){setMov(null);setQty('1');},
        title:mov&&mov.type==='entrada'?'Dar Entrada':'Dar Saída',
        footer:h(Frag,null,
          h('button',{className:'btn btn-o',onClick:function(){setMov(null);}}, 'Cancelar'),
          h('button',{className:'btn '+(mov&&mov.type==='entrada'?'btn-p':'btn-danger'),onClick:doMov,disabled:busy},busy?'Registrando...':'Confirmar')
        )},
        h('p',{style:{fontSize:'.875rem',marginBottom:8}},'Produto: ',h('strong',null,mov&&mov.variation?mov.variation.name||'Padrão':'')),
        h('label',{className:'lbl'},'Quantidade'),
        h('input',{className:'input',type:'number',min:1,value:qty,onChange:function(e){setQty(e.target.value);},autoFocus:true})
      )
    );
  }

  // ── NEW PRODUCT ────────────────────────────────────────────────────
  function NewProduct(props) {
    var goTo = props.goTo;
    var _f=us({name:'',category:'sofa',condition:'novo'});var f=_f[0];var setF=_f[1];
    // variations inline
    var _vs=us([{name:'',size:'',fabric:''}]);var vs=_vs[0];var setVs=_vs[1];
    var _busy=us(false);var busy=_busy[0];var setBusy=_busy[1];

    function addVar(){setVs(vs.concat({name:'',size:'',fabric:''}));}
    function removeVar(i){setVs(vs.filter(function(_,j){return j!==i;}));}
    function setVar(i,k,v){var nv=vs.map(function(x,j){return j===i?Object.assign({},x,{[k]:v}):x;});setVs(nv);}

    async function submit(e){
      e.preventDefault();
      if(!f.name){toast('Preencha o nome','err');return;}
      setBusy(true);
      var {data:prod,error:pe} = await sb.from('products').insert({name:f.name,category:f.category,condition:f.condition}).select().single();
      if(pe){toast('Erro: '+pe.message,'err');setBusy(false);return;}
      // Insert variations
      var validVars = vs.filter(function(v){return v.name&&v.name.trim();});
      if(validVars.length>0){
        var insVars = validVars.map(function(v){return {product_id:prod.id,name:v.name.trim(),size:v.size||null,fabric:v.fabric||null};});
        var {error:ve} = await sb.from('product_variations').insert(insVars);
        if(ve){
          // If product_variations doesn't exist, just continue without variations
          console.warn('product_variations table may not exist:', ve.message);
        }
      }
      toast('✓ Produto cadastrado!','ok');
      goTo('products');
    }

    return h('div',{className:'ai'},
      h('button',{className:'back-btn',onClick:function(){goTo('products');}},h(Ic,{n:'left',s:15}),' Voltar'),
      h('div',{className:'card'},
        h('div',{className:'cb'},
          h('h2',{style:{fontFamily:'Fraunces,serif',fontSize:'1.35rem',fontWeight:700,marginBottom:'1.25rem'}},'Cadastrar Produto'),
          h('form',{onSubmit:submit},
            h('div',{className:'fg'},h('label',{className:'lbl'},'Nome do Produto *'),h('input',{className:'input',value:f.name,onChange:function(e){setF(Object.assign({},f,{name:e.target.value}));},placeholder:'Ex: Sofá Milano',required:true})),
            h('div',{className:'fgrid'},
              h('div',{className:'fg'},h('label',{className:'lbl'},'Categoria'),
                h('select',{className:'sel',value:f.category,onChange:function(e){setF(Object.assign({},f,{category:e.target.value}));}},
                  CATS.map(function(c){return h('option',{key:c.id,value:c.id},c.label.slice(0,-1));}) // remove plural 's'
                )
              ),
              h('div',{className:'fg'},h('label',{className:'lbl'},'Condição'),
                h('select',{className:'sel',value:f.condition,onChange:function(e){setF(Object.assign({},f,{condition:e.target.value}));}},
                  h('option',{value:'novo'},'Novo'),
                  h('option',{value:'leves_defeitos'},'Leves Defeitos'),
                  h('option',{value:'assistencia'},'Assistência')
                )
              )
            ),
            h('div',{className:'divider'}),
            h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}},
              h('p',{style:{fontWeight:600,fontSize:'.9rem'}},'Variações'),
              h('button',{type:'button',className:'btn btn-o btn-sm',onClick:addVar,style:{display:'inline-flex',alignItems:'center',gap:6}},h(Ic,{n:'plus',s:12}),'Adicionar')
            ),
            h('div',{className:'sy2'},
              vs.map(function(v,i){
                return h('div',{key:i,style:{background:'var(--bg)',borderRadius:'var(--rs)',padding:'12px',position:'relative'}},
                  vs.length>1 && h('button',{type:'button',onClick:function(){removeVar(i);},style:{position:'absolute',top:8,right:8,background:'none',border:'none',cursor:'pointer',color:'var(--text3)'}},h(Ic,{n:'trash',s:14})),
                  h('div',{className:'fg'},h('label',{className:'lbl'},'Nome da Variação *'),h('input',{className:'input',value:v.name,onChange:function(e){setVar(i,'name',e.target.value);},placeholder:'Ex: 2 lugares, Azul, 1.80m...'})),
                  h('div',{className:'fgrid'},
                    h('div',{className:'fg'},h('label',{className:'lbl'},'Tamanho'),h('input',{className:'input',value:v.size,onChange:function(e){setVar(i,'size',e.target.value);},placeholder:'Ex: 2.20m'})),
                    h('div',{className:'fg'},h('label',{className:'lbl'},'Tecido'),h('input',{className:'input',value:v.fabric,onChange:function(e){setVar(i,'fabric',e.target.value);},placeholder:'Ex: Linho'}))
                  )
                );
              })
            ),
            h('div',{style:{marginTop:'1.25rem'}}),
            h('button',{className:'btn btn-p btn-full',type:'submit',disabled:busy,style:{justifyContent:'center'}},busy?'Cadastrando...':'Cadastrar Produto')
          )
        )
      )
    );
  }

  // ── NEW VARIATION (for existing products) ─────────────────────────
  function NewVariation(props) {
    var goTo = props.goTo;
    var prodId = props.prodId;
    var _pname=us('');var pname=_pname[0];var setPname=_pname[1];
    var _f=us({name:'',size:'',fabric:''});var f=_f[0];var setF=_f[1];
    var _busy=us(false);var busy=_busy[0];var setBusy=_busy[1];

    ue(function(){
      sb.from('products').select('name').eq('id',prodId).single().then(function(res){
        if(res.data) setPname(res.data.name);
      });
    },[prodId]);

    async function submit(e){
      e.preventDefault();
      if(!f.name){toast('Preencha o nome da variação','err');return;}
      setBusy(true);
      var {error} = await sb.from('product_variations').insert({product_id:prodId,name:f.name,size:f.size||null,fabric:f.fabric||null});
      setBusy(false);
      if(error){toast('Erro: '+error.message,'err');return;}
      toast('✓ Variação adicionada!','ok');
      goTo('products');
    }

    return h('div',{className:'ai'},
      h('button',{className:'back-btn',onClick:function(){goTo('products');}},h(Ic,{n:'left',s:15}),' Voltar'),
      h('div',{className:'card'},
        h('div',{className:'cb'},
          h('p',{style:{fontSize:'.8rem',color:'var(--text3)',marginBottom:4}},'Variação de'),
          h('h2',{style:{fontFamily:'Fraunces,serif',fontSize:'1.2rem',fontWeight:700,marginBottom:'1.25rem'}},pname||'Produto'),
          h('form',{onSubmit:submit},
            h('div',{className:'fg'},h('label',{className:'lbl'},'Nome da Variação *'),h('input',{className:'input',value:f.name,onChange:function(e){setF(Object.assign({},f,{name:e.target.value}));},placeholder:'Ex: 2 lugares Azul, 1.80m...',required:true})),
            h('div',{className:'fgrid'},
              h('div',{className:'fg'},h('label',{className:'lbl'},'Tamanho'),h('input',{className:'input',value:f.size,onChange:function(e){setF(Object.assign({},f,{size:e.target.value}));},placeholder:'Ex: 2.20m'})),
              h('div',{className:'fg'},h('label',{className:'lbl'},'Tecido'),h('input',{className:'input',value:f.fabric,onChange:function(e){setF(Object.assign({},f,{fabric:e.target.value}));},placeholder:'Ex: Linho'}))
            ),
            h('button',{className:'btn btn-p btn-full',type:'submit',disabled:busy,style:{justifyContent:'center'}},busy?'Salvando...':'Adicionar Variação')
          )
        )
      )
    );
  }

  // ── REPORTS ────────────────────────────────────────────────────────
  function Reports() {
    var _movs=us([]);var movs=_movs[0];var setMovs=_movs[1];
    var _loading=us(true);var loading=_loading[0];var setLoading=_loading[1];
    var _from=us('');var from=_from[0];var setFrom=_from[1];
    var _to=us('');var to=_to[0];var setTo=_to[1];

    async function load(){
      setLoading(true);
      var q = sb.from('stock_movements').select('id,type,quantity,created_at,product_id,variation_id,user_id').order('created_at',{ascending:false});
      if(from) q=q.gte('created_at',from+'T00:00:00');
      if(to)   q=q.lte('created_at',to+'T23:59:59');
      var {data} = await q;
      if(!data||!data.length){setMovs([]);setLoading(false);return;}
      var pids=[...new Set(data.map(function(m){return m.product_id;}).filter(Boolean))];
      var vids=[...new Set(data.map(function(m){return m.variation_id;}).filter(Boolean))];
      var uids=[...new Set(data.map(function(m){return m.user_id;}).filter(Boolean))];
      var [r1,r2,r3] = await Promise.all([
        pids.length?sb.from('products').select('id,name,category').in('id',pids):{data:[]},
        vids.length?sb.from('product_variations').select('id,name').in('id',vids):{data:[]},
        uids.length?sb.from('profiles').select('user_id,full_name').in('user_id',uids):{data:[]},
      ]);
      var pm=new Map((r1.data||[]).map(function(p){return [p.id,p];}));
      var vm=new Map((r2.data||[]).map(function(v){return [v.id,v];}));
      var um=new Map((r3.data||[]).map(function(p){return [p.user_id,p.full_name];}));
      setMovs(data.map(function(m){
        var prod=pm.get(m.product_id);
        var vari=m.variation_id?vm.get(m.variation_id):null;
        return Object.assign({},m,{
          pname:prod?prod.name:'—',
          pcat:prod?prod.category:'',
          vname:vari?vari.name:'',
          uname:um.get(m.user_id)||'—'
        });
      }));
      setLoading(false);
    }
    ue(function(){load();},[from,to]);

    var ent=movs.filter(function(m){return m.type==='entrada';}).reduce(function(s,m){return s+m.quantity;},0);
    var sai=movs.filter(function(m){return m.type==='saida';}).reduce(function(s,m){return s+m.quantity;},0);
    function fmt(iso){var d=new Date(iso);return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'})+' '+d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});}

    return h('div',{className:'ai'},
      h('h1',{className:'pt',style:{marginBottom:'1rem'}},'Relatórios'),
      h('div',{className:'card',style:{marginBottom:12}},
        h('div',{className:'cb'},
          h('div',{className:'fgrid'},
            h('div',null,h('label',{className:'lbl'},'Data Início'),h('input',{className:'input',type:'date',value:from,onChange:function(e){setFrom(e.target.value);}})),
            h('div',null,h('label',{className:'lbl'},'Data Fim'),h('input',{className:'input',type:'date',value:to,onChange:function(e){setTo(e.target.value);}}))
          )
        )
      ),
      h('div',{className:'stat-grid'},
        h('div',{className:'card'},h('div',{className:'stat-card'},
          h('div',{className:'stat-icon',style:{background:'rgba(45,106,79,.12)',color:'var(--green)'}},h(Ic,{n:'down',s:20})),
          h('div',null,h('div',{className:'stat-lbl'},'Entradas'),h('div',{className:'stat-val',style:{color:'var(--green)'}},ent))
        )),
        h('div',{className:'card'},h('div',{className:'stat-card'},
          h('div',{className:'stat-icon',style:{background:'rgba(192,57,43,.12)',color:'var(--red)'}},h(Ic,{n:'up',s:20})),
          h('div',null,h('div',{className:'stat-lbl'},'Saídas'),h('div',{className:'stat-val',style:{color:'var(--red)'}},sai))
        ))
      ),
      loading?h('div',{className:'loading'},'Carregando...')
      :movs.length===0?h('div',{className:'card card-dash'},h('div',{className:'empty'},h(Ic,{n:'chart',s:48}),h('p',null,'Nenhuma movimentação encontrada')))
      :h('div',{className:'card'},
          movs.map(function(m){
            return h('div',{key:m.id,className:'mov-row'},
              h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',gap:8}},
                h('div',{style:{flex:1,minWidth:0}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('span',{className:'badge '+(m.type==='entrada'?'b-green':'b-red')},(m.type==='entrada'?'+':'−')+m.quantity),
                    h('span',{style:{fontWeight:600,fontSize:'.875rem',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},m.pname+(m.vname?' · '+m.vname:''))
                  ),
                  h('div',{style:{display:'flex',gap:6,marginTop:4,fontSize:'.72rem',color:'var(--text3)',alignItems:'center'}},
                    h(Ic,{n:'clock',s:11}),h('span',null,m.uname),h('span',null,'·'),h('span',null,fmt(m.created_at))
                  )
                ),
                h('span',{className:'badge b-sec',style:{flexShrink:0}},CAT_MAP[m.pcat]||m.pcat)
              )
            );
          })
        )
    );
  }

  // ── USERS ──────────────────────────────────────────────────────────
  function Users() {
    var auth = useAuth();
    var _users=us([]);var users=_users[0];var setUsers=_users[1];
    var _loading=us(true);var loading=_loading[0];var setLoading=_loading[1];
    var _showC=us(false);var showC=_showC[0];var setShowC=_showC[1];
    var _creating=us(false);var creating=_creating[0];var setCreating=_creating[1];
    var _eu=us(null);var eu=_eu[0];var setEu=_eu[1];
    var _er=us('visualizador');var er=_er[0];var setEr=_er[1];
    var _saving=us(false);var saving=_saving[0];var setSaving=_saving[1];
    var _nu=us({email:'',password:'',fullName:'',role:'visualizador'});var nu=_nu[0];var setNu=_nu[1];

    async function loadUsers(){
      var [r1,r2] = await Promise.all([
        sb.from('profiles').select('user_id,full_name'),
        sb.from('user_roles').select('user_id,role'),
      ]);
      var rm=new Map((r2.data||[]).map(function(r){return [r.user_id,r.role];}));
      setUsers((r1.data||[]).map(function(p){return Object.assign({},p,{role:rm.get(p.user_id)||null});}));
      setLoading(false);
    }
    ue(function(){loadUsers();},[]);

    async function create(){
      if(!nu.email||!nu.password||!nu.fullName){toast('Preencha todos os campos','err');return;}
      if(nu.password.length<6){toast('Senha mínimo 6 caracteres','err');return;}
      setCreating(true);
      var {data,error} = await sb.auth.signUp({email:nu.email,password:nu.password,options:{data:{full_name:nu.fullName}}});
      if(error||!data.user){toast(error?error.message:'Erro ao criar usuário','err');setCreating(false);return;}
      // Use upsert to avoid conflicts
      await sb.from('user_roles').upsert({user_id:data.user.id,role:nu.role},{onConflict:'user_id'});
      toast('✓ Usuário criado!','ok');
      setShowC(false);setNu({email:'',password:'',fullName:'',role:'visualizador'});
      setCreating(false);loadUsers();
    }

    async function saveRole(){
      if(!eu) return;
      setSaving(true);
      // upsert by user_id to ensure update always works
      var {error} = await sb.from('user_roles').upsert({user_id:eu.user_id,role:er},{onConflict:'user_id'});
      setSaving(false);
      if(error){toast('Erro ao salvar: '+error.message,'err');return;}
      toast('✓ Papel atualizado!','ok');setEu(null);loadUsers();
    }

    var RBADGE={gestor:'b-primary',editor:'b-green',visualizador:'b-sec'};
    function rl(r){return r?r[0].toUpperCase()+r.slice(1):'Sem papel';}

    return h('div',{className:'ai'},
      h('div',{className:'ph'},
        h('h1',{className:'pt'},'Usuários'),
        h('button',{className:'btn btn-p btn-sm',onClick:function(){setShowC(true);},style:{display:'inline-flex',alignItems:'center',gap:6}},h(Ic,{n:'uplus',s:14}),'Novo')
      ),
      loading?h('div',{className:'loading'},'Carregando...')
      :users.length===0?h('div',{className:'card card-dash'},h('div',{className:'empty'},h(Ic,{n:'users',s:48}),h('p',null,'Nenhum usuário')))
      :h('div',{className:'card'},
          users.map(function(u){
            return h('div',{key:u.user_id,className:'mov-row'},
              h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',gap:8}},
                h('div',null,
                  h('div',{style:{fontWeight:600,fontSize:'.875rem'}},u.full_name),
                  u.user_id===(auth.user?auth.user.id:'')&&h('div',{style:{fontSize:'.72rem',color:'var(--text3)'}},'Você')
                ),
                h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                  h('span',{className:'badge '+(RBADGE[u.role]||'b-warn')},rl(u.role)),
                  u.user_id!==(auth.user?auth.user.id:'')&&h('button',{className:'btn btn-o btn-sm',style:{display:'inline-flex',alignItems:'center',gap:5},onClick:function(){setEu(u);setEr(u.role||'visualizador');}},h(Ic,{n:'edit',s:12}),'Papel')
                )
              )
            );
          })
        ),
      // Create
      h(Modal,{open:showC,onClose:function(){setShowC(false);},title:'Criar Novo Usuário',
        footer:h(Frag,null,
          h('button',{className:'btn btn-o',onClick:function(){setShowC(false);}},'Cancelar'),
          h('button',{className:'btn btn-p',onClick:create,disabled:creating},creating?'Criando...':'Criar Usuário')
        )},
        h('div',{className:'fg'},h('label',{className:'lbl'},'Nome Completo'),h('input',{className:'input',value:nu.fullName,onChange:function(e){setNu(Object.assign({},nu,{fullName:e.target.value}));},placeholder:'Nome do colaborador'})),
        h('div',{className:'fg'},h('label',{className:'lbl'},'Email'),h('input',{className:'input',type:'email',value:nu.email,onChange:function(e){setNu(Object.assign({},nu,{email:e.target.value}));},placeholder:'email@exemplo.com'})),
        h('div',{className:'fg'},h('label',{className:'lbl'},'Senha'),h('input',{className:'input',type:'password',value:nu.password,onChange:function(e){setNu(Object.assign({},nu,{password:e.target.value}));},placeholder:'Mínimo 6 caracteres'})),
        h('div',{className:'fg'},h('label',{className:'lbl'},'Papel'),
          h('select',{className:'sel',value:nu.role,onChange:function(e){setNu(Object.assign({},nu,{role:e.target.value}));}},
            h('option',{value:'gestor'},'Gestor'),h('option',{value:'editor'},'Editor'),h('option',{value:'visualizador'},'Visualizador')
          )
        )
      ),
      // Edit role
      h(Modal,{open:!!eu,onClose:function(){setEu(null);},title:'Editar Papel',
        footer:h(Frag,null,
          h('button',{className:'btn btn-o',onClick:function(){setEu(null);}},'Cancelar'),
          h('button',{className:'btn btn-p',onClick:saveRole,disabled:saving},saving?'Salvando...':'Salvar')
        )},
        h('p',{style:{fontSize:'.875rem',marginBottom:12}},'Usuário: ',h('strong',null,eu?eu.full_name:'')),
        h('label',{className:'lbl'},'Papel'),
        h('select',{className:'sel',value:er,onChange:function(e){setEr(e.target.value);}},
          h('option',{value:'gestor'},'Gestor'),h('option',{value:'editor'},'Editor'),h('option',{value:'visualizador'},'Visualizador')
        )
      )
    );
  }

  // ── LAYOUT ─────────────────────────────────────────────────────────
  function Layout(props) {
    var page=props.page,goTo=props.goTo,auth=props.auth;
    var nav=[
      {id:'products',label:'Produtos',icon:'box'},
      {id:'reports',label:'Relatórios',icon:'chart'},
    ];
    if(auth.role==='gestor') nav.push({id:'users',label:'Usuários',icon:'users'});

    return h('div',{className:'shell'},
      h('header',{className:'topbar'},
        h('div',{className:'logo'},
          h('div',{className:'logo-icon'},h(Ic,{n:'pkg',s:20,c:'#FAF7F2'})),
          h('span',{className:'logo-name'},'Castellar')
        ),
        (auth.role==='gestor'||auth.role==='editor')&&page==='products'&&
          h('button',{className:'btn btn-p btn-sm',onClick:function(){goTo('new-product');},style:{display:'inline-flex',alignItems:'center',gap:6}},h(Ic,{n:'plus',s:14}),'Produto')
      ),
      h('div',{className:'body'},
        h('aside',{className:'sidebar'},
          nav.map(function(item){
            return h('button',{key:item.id,className:'sb'+(page===item.id?' on':''),onClick:function(){goTo(item.id);}},h(Ic,{n:item.icon,s:17}),item.label);
          }),
          h('div',{className:'sb-sp'}),
          h('div',{className:'sb-u'},
            h('div',{className:'sb-name'},auth.pname||'—'),
            h('div',{className:'sb-role'},auth.role||''),
            h('button',{className:'sb danger',onClick:auth.signOut},h(Ic,{n:'out',s:16}),'Sair')
          )
        ),
        h('main',{className:'main'},props.children)
      ),
      h('nav',{className:'bnav'},
        nav.map(function(item){
          return h('button',{key:item.id,className:'bni'+(page===item.id?' on':''),onClick:function(){goTo(item.id);}},
            h(Ic,{n:item.icon,s:22}),h('span',null,item.label)
          );
        })
      )
    );
  }

  // ── ROUTER ─────────────────────────────────────────────────────────
  function Router() {
    var auth = useAuth();
    var _pg=us('products');var page=_pg[0];var setPage=_pg[1];
    var _pdId=us(null);var prodId=_pdId[0];var setProdId=_pdId[1];

    function goTo(p){
      if(p.startsWith('new-variation-')){
        setProdId(p.replace('new-variation-',''));
        setPage('new-variation');
      } else {
        setProdId(null);
        setPage(p);
      }
      window.scrollTo(0,0);
    }

    if(auth.user===undefined) return h('div',{className:'loading',style:{paddingTop:'40vh'}},'Carregando...');
    if(!auth.user) return h(Login);
    if(!auth.role) return h(Pending);

    var canEdit = auth.role==='gestor'||auth.role==='editor';

    var content;
    if(page==='new-product'&&canEdit) content=h(NewProduct,{goTo:goTo});
    else if(page==='new-variation'&&canEdit&&prodId) content=h(NewVariation,{goTo:goTo,prodId:prodId});
    else if(page==='reports'&&auth.role!=='visualizador'&&false) content=h(Reports); // unreachable — visualizador CAN'T see reports
    else if(page==='reports') {
      // Only gestor and editor can see reports
      if(auth.role==='gestor'||auth.role==='editor') content=h(Reports);
      else { setPage('products'); content=h(Products,{goTo:goTo}); }
    }
    else if(page==='users'&&auth.role==='gestor') content=h(Users);
    else content=h(Products,{goTo:goTo});

    return h(Layout,{page:page,goTo:goTo,auth:auth},content);
  }

  RD.createRoot(document.getElementById('root')).render(h(AuthProv,null,h(Router)));
}
</script>
</body>
</html>
