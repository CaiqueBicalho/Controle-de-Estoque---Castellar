<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estoque Castellar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">

  <!-- Libs carregadas via CDN clássico (sem ES modules - funciona em file://) -->
  <script src="https://unpkg.com/react@18.3.1/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #FAF7F2; --bg2: #F3EDE3; --card: #FFFFFF;
      --border: #E8DDD0; --text: #1C1410; --text2: #6B5B4E; --text3: #9E8E82;
      --primary: #5C3D2E; --primary-fg: #FAF7F2;
      --entrada: #2D6A4F; --saida: #C0392B; --warning: #E67E22;
      --shadow: 0 1px 3px rgba(92,61,46,0.08); --shadow-md: 0 4px 16px rgba(92,61,46,0.14);
      --radius: 12px; --radius-sm: 8px;
    }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
    h1, h2, h3 { font-family: 'Fraunces', serif; }
    .app-shell { display: flex; flex-direction: column; min-height: 100vh; }
    .topbar { position: sticky; top: 0; z-index: 50; background: rgba(255,255,255,0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 0 1rem; height: 56px; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon { width: 34px; height: 34px; border-radius: 10px; background: var(--primary); display: flex; align-items: center; justify-content: center; }
    .logo-name { font-family: 'Fraunces', serif; font-size: 1.1rem; font-weight: 600; }
    .body-area { display: flex; flex: 1; }
    .sidebar { width: 220px; flex-shrink: 0; border-right: 1px solid var(--border); background: var(--card); padding: 1rem 0.75rem; display: flex; flex-direction: column; gap: 2px; }
    @media (max-width: 768px) { .sidebar { display: none; } }
    .sidebar-item { display: flex; align-items: center; gap: 10px; padding: 9px 12px; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 500; color: var(--text2); cursor: pointer; border: none; background: none; width: 100%; text-align: left; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
    .sidebar-item:hover { background: var(--bg); color: var(--text); }
    .sidebar-item.active { background: var(--primary); color: var(--primary-fg); }
    .sidebar-item.danger { color: var(--saida); }
    .sidebar-item.danger:hover { background: rgba(192,57,43,0.08); }
    .sidebar-spacer { flex: 1; }
    .sidebar-user { border-top: 1px solid var(--border); padding-top: 0.75rem; margin-top: 0.5rem; }
    .sidebar-user-name { font-size: 0.85rem; font-weight: 600; padding: 0 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sidebar-user-role { font-size: 0.72rem; color: var(--text3); padding: 0 4px; margin-bottom: 6px; text-transform: capitalize; }
    .main { flex: 1; padding: 1.25rem 1rem; max-width: 800px; margin: 0 auto; width: 100%; }
    @media (min-width: 769px) { .main { padding: 1.5rem 2rem; } }
    .bottom-nav { position: sticky; bottom: 0; z-index: 50; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-top: 1px solid var(--border); display: flex; }
    @media (min-width: 769px) { .bottom-nav { display: none; } }
    .bottom-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 8px 4px 10px; font-size: 0.68rem; font-weight: 500; color: var(--text3); cursor: pointer; border: none; background: none; transition: color 0.15s; font-family: 'DM Sans', sans-serif; }
    .bottom-nav-item.active { color: var(--primary); }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; white-space: nowrap; font-family: 'DM Sans', sans-serif; }
    .btn-primary { background: var(--primary); color: var(--primary-fg); }
    .btn-primary:hover:not(:disabled) { background: #4a3024; }
    .btn-outline { background: transparent; color: var(--text); border: 1.5px solid var(--border); }
    .btn-outline:hover:not(:disabled) { background: var(--bg); }
    .btn-danger { background: var(--saida); color: white; }
    .btn-danger:hover:not(:disabled) { background: #a93226; }
    .btn-sm { padding: 6px 12px; font-size: 0.82rem; }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .btn-full { justify-content: center; width: 100%; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .card-body { padding: 1rem; }
    .card-dashed { border-style: dashed; background: transparent; box-shadow: none; }
    .input { width: 100%; padding: 9px 12px; border-radius: var(--radius-sm); border: 1.5px solid var(--border); background: var(--card); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--text); outline: none; transition: border-color 0.15s; }
    .input:focus { border-color: var(--primary); }
    .input::placeholder { color: var(--text3); }
    .select { width: 100%; padding: 9px 32px 9px 12px; border-radius: var(--radius-sm); border: 1.5px solid var(--border); background: var(--card); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--text); outline: none; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239E8E82' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; transition: border-color 0.15s; }
    .select:focus { border-color: var(--primary); }
    .label { display: block; font-size: 0.82rem; font-weight: 600; color: var(--text2); margin-bottom: 5px; }
    .form-group { margin-bottom: 1rem; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 400px) { .form-grid { grid-template-columns: 1fr; } }
    .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 100px; font-size: 0.72rem; font-weight: 600; border: 1px solid transparent; }
    .badge-secondary { background: var(--bg2); color: var(--text2); border-color: var(--border); }
    .badge-entrada { background: rgba(45,106,79,0.12); color: var(--entrada); border-color: rgba(45,106,79,0.3); }
    .badge-saida { background: rgba(192,57,43,0.12); color: var(--saida); border-color: rgba(192,57,43,0.3); }
    .badge-gestor { background: rgba(92,61,46,0.12); color: var(--primary); border-color: rgba(92,61,46,0.3); }
    .badge-editor { background: rgba(45,106,79,0.12); color: var(--entrada); border-color: rgba(45,106,79,0.3); }
    .badge-visualizador, .badge-sem { background: var(--bg2); color: var(--text3); border-color: var(--border); }
    .modal-overlay { position: fixed; inset: 0; z-index: 100; background: rgba(28,20,16,0.45); display: flex; align-items: center; justify-content: center; padding: 1rem; animation: fadeIn 0.15s ease; }
    .modal { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow-md); width: 100%; max-width: 400px; animation: slideUp 0.2s ease; }
    .modal-header { padding: 1.25rem 1.25rem 0; }
    .modal-title { font-size: 1.1rem; font-family: 'Fraunces', serif; font-weight: 600; }
    .modal-body { padding: 1rem 1.25rem; }
    .modal-footer { padding: 0 1.25rem 1.25rem; display: flex; gap: 8px; justify-content: flex-end; }
    .toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 200; display: flex; flex-direction: column; gap: 8px; align-items: center; pointer-events: none; }
    @media (min-width: 769px) { .toast-container { bottom: 20px; } }
    .toast { background: var(--text); color: var(--bg); padding: 10px 20px; border-radius: var(--radius-sm); font-size: 0.875rem; font-weight: 500; box-shadow: var(--shadow-md); pointer-events: auto; animation: slideUp 0.2s ease; max-width: 320px; text-align: center; }
    .toast.success { background: var(--entrada); color: white; }
    .toast.error { background: var(--saida); color: white; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
    .page-title { font-size: 1.5rem; font-family: 'Fraunces', serif; font-weight: 700; }
    .product-stock { font-size: 1.75rem; font-weight: 700; }
    .mov-btn { flex: 1; padding: 7px 10px; border-radius: var(--radius-sm); border: 1.5px solid; background: transparent; cursor: pointer; font-size: 0.82rem; font-weight: 600; font-family: 'DM Sans', sans-serif; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.15s; }
    .mov-btn-e { border-color: rgba(45,106,79,0.4); color: var(--entrada); }
    .mov-btn-e:hover { background: rgba(45,106,79,0.08); }
    .mov-btn-s { border-color: rgba(192,57,43,0.4); color: var(--saida); }
    .mov-btn-s:hover { background: rgba(192,57,43,0.08); }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1rem; text-align: center; gap: 12px; color: var(--text3); }
    .stat-card { padding: 1rem; display: flex; align-items: center; gap: 12px; }
    .stat-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .stat-label { font-size: 0.75rem; color: var(--text3); margin-bottom: 2px; }
    .stat-value { font-size: 1.75rem; font-weight: 700; }
    .mov-row { padding: 0.75rem 1rem; }
    .mov-row:not(:last-child) { border-bottom: 1px solid var(--border); }
    .back-btn { display: inline-flex; align-items: center; gap: 6px; color: var(--text3); font-size: 0.875rem; cursor: pointer; border: none; background: none; margin-bottom: 1rem; padding: 0; font-family: 'DM Sans', sans-serif; transition: color 0.15s; }
    .back-btn:hover { color: var(--text); }
    .login-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; background: radial-gradient(ellipse at 60% 20%, rgba(92,61,46,0.06) 0%, transparent 60%), var(--bg); }
    .login-card { width: 100%; max-width: 360px; background: var(--card); border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-md); padding: 2rem; }
    .login-icon { width: 52px; height: 52px; border-radius: 14px; background: var(--primary); display: flex; align-items: center; justify-content: center; margin: 0 auto 1.25rem; }
    .login-title { font-size: 1.5rem; font-family: 'Fraunces', serif; font-weight: 700; text-align: center; }
    .login-sub { text-align: center; color: var(--text3); font-size: 0.875rem; margin-top: 4px; margin-bottom: 1.5rem; }
    .error-msg { background: rgba(192,57,43,0.08); border: 1px solid rgba(192,57,43,0.3); color: var(--saida); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 0.85rem; margin-bottom: 12px; }
    .pending-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; background: var(--bg); }
    .pending-card { text-align: center; max-width: 380px; width: 100%; background: var(--card); border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-md); padding: 2.5rem 2rem; }
    .pending-icon { width: 64px; height: 64px; border-radius: 16px; background: rgba(230,126,34,0.12); display: flex; align-items: center; justify-content: center; margin: 0 auto 1.25rem; color: var(--warning); }
    .pending-title { font-family: 'Fraunces', serif; font-size: 1.35rem; font-weight: 700; margin-bottom: 8px; }
    .pending-sub { color: var(--text2); font-size: 0.9rem; line-height: 1.5; }
    .pending-id { margin-top: 1.5rem; font-size: 0.72rem; color: var(--text3); background: var(--bg2); padding: 8px 12px; border-radius: 8px; word-break: break-all; font-family: monospace; }
    .loading { text-align: center; padding: 3rem; color: var(--text3); animation: pulse 1.5s ease infinite; font-family: 'Fraunces', serif; }
    .animate-in { animation: slideUp 0.3s ease; }
    .space-y > * + * { margin-top: 8px; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  </style>
</head>
<body>
<div id="root"><div class="loading" style="padding-top:40vh">Carregando...</div></div>
<div class="toast-container" id="toasts"></div>

<script>
// Aguarda todos os scripts carregarem antes de executar
window.addEventListener('load', function() {
  // Verificar se as libs carregaram
  if (!window.React || !window.ReactDOM || !window.supabase) {
    document.getElementById('root').innerHTML =
      '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:16px;padding:2rem;text-align:center">' +
      '<p style="font-size:1rem;color:#C0392B;font-weight:600">Erro ao carregar bibliotecas</p>' +
      '<p style="font-size:0.85rem;color:#6B5B4E">Verifique sua conexão com a internet e recarregue a página.</p>' +
      '<button onclick="location.reload()" style="padding:8px 20px;background:#5C3D2E;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.875rem">Recarregar</button>' +
      '</div>';
    return;
  }

  initApp();
});

function initApp() {
  var React = window.React;
  var ReactDOM = window.ReactDOM;
  var supabaseLib = window.supabase;

  var h = React.createElement;
  var useState = React.useState;
  var useEffect = React.useEffect;
  var useContext = React.useContext;
  var createContext = React.createContext;
  var Fragment = React.Fragment;
  var createRoot = ReactDOM.createRoot;

  var SUPABASE_URL = 'https://kskmgyuocnsebwgdgeiu.supabase.co';
  var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtza21neXVvY25zZWJ3Z2RnZWl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNjIwMzksImV4cCI6MjA4NjkzODAzOX0.Bzqpz3dPVoSaP2YA8pJimt5Jf73oxcll7-Y2Qc8ctp0';
  var OWNER_EMAIL = 'bicalho.ca@gmail.com';
  var sb = supabaseLib.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ── TOAST ──────────────────────────────────────────────────────────
  function toast(msg, type) {
    var el = document.createElement('div');
    el.className = 'toast' + (type ? ' ' + type : '');
    el.textContent = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(function() { el.remove(); }, 3500);
  }

  // ── ICONS ──────────────────────────────────────────────────────────
  var SVG = {
    Package: '<path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>',
    Box: '<path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>',
    BarChart: '<line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/>',
    Users: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
    Plus: '<path d="M5 12h14"/><path d="M12 5v14"/>',
    Minus: '<path d="M5 12h14"/>',
    LogOut: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>',
    ArrowLeft: '<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
    ArrowDown: '<path d="M12 5v14"/><path d="m19 12-7 7-7-7"/>',
    ArrowUp: '<path d="m5 12 7-7 7 7"/><path d="M12 19V5"/>',
    Clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
    UserPlus: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/>',
    Lock: '<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
    Refresh: '<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>',
  };

  function Icon(props) {
    var name = props.name, size = props.size || 20, color = props.color || 'currentColor';
    return h('svg', {
      xmlns: 'http://www.w3.org/2000/svg', width: size, height: size,
      viewBox: '0 0 24 24', fill: 'none', stroke: color,
      strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round',
      style: { flexShrink: 0, display: 'inline-block', verticalAlign: 'middle' },
      dangerouslySetInnerHTML: { __html: SVG[name] || '' }
    });
  }

  // ── AUTH ───────────────────────────────────────────────────────────
  var AuthCtx = createContext(null);
  var useAuth = function() { return useContext(AuthCtx); };

  function AuthProvider(props) {
    var _user = useState(undefined); var user = _user[0]; var setUser = _user[1];
    var _role = useState(null); var role = _role[0]; var setRole = _role[1];
    var _name = useState(null); var profileName = _name[0]; var setProfileName = _name[1];

    async function loadRole(u) {
      if (!u) { setRole(null); setProfileName(null); return; }
      try {
        var isOwner = u.email && u.email.toLowerCase() === OWNER_EMAIL;
        if (isOwner) {
          var ex = await sb.from('user_roles').select('role').eq('user_id', u.id).maybeSingle();
          if (!ex.data) {
            await sb.from('user_roles').insert({ user_id: u.id, role: 'gestor' });
          } else if (ex.data.role !== 'gestor') {
            await sb.from('user_roles').update({ role: 'gestor' }).eq('user_id', u.id);
          }
          setRole('gestor');
        } else {
          var res = await sb.from('user_roles').select('role').eq('user_id', u.id).maybeSingle();
          if (!res.data) {
            // Atribui papel inicial de 'visualizador' para que o usuário consiga logar
            await sb.from('user_roles').insert({ user_id: u.id, role: 'visualizador' });
            setRole('visualizador');
          } else {
            setRole(res.data.role);
          }
        }
        var pRes = await sb.from('profiles').select('full_name').eq('user_id', u.id).maybeSingle();
        setProfileName(pRes.data ? pRes.data.full_name : u.email);
      } catch(e) {
        console.error('loadRole error:', e);
        setRole(null);
      }
    }

    useEffect(function() {
      sb.auth.getSession().then(function(res) {
        var u = res.data.session ? res.data.session.user : null;
        setUser(u);
        loadRole(u);
      });
      var sub = sb.auth.onAuthStateChange(function(event, session) {
        if (event === 'INITIAL_SESSION') return;
        var u = session ? session.user : null;
        setUser(u);
        loadRole(u);
      });
      return function() { sub.data.subscription.unsubscribe(); };
    }, []);

    async function signIn(email, password) {
      try {
        var res = await sb.auth.signInWithPassword({ email: email, password: password });
        if (res.error) return { error: res.error.message };
        return { error: null };
      } catch(e) { return { error: 'Erro de conexão. Verifique sua internet.' }; }
    }

    async function signOut() {
      await sb.auth.signOut();
      setUser(null); setRole(null); setProfileName(null);
    }

    async function refreshRole() { if (user) await loadRole(user); }

    return h(AuthCtx.Provider, {
      value: { user: user, role: role, profileName: profileName, signIn: signIn, signOut: signOut, refreshRole: refreshRole }
    }, props.children);
  }

  // ── MODAL ──────────────────────────────────────────────────────────
  function Modal(props) {
    if (!props.open) return null;
    return h('div', { className: 'modal-overlay', onClick: function(e) { if (e.target === e.currentTarget) props.onClose(); } },
      h('div', { className: 'modal' },
        h('div', { className: 'modal-header' }, h('h3', { className: 'modal-title' }, props.title)),
        h('div', { className: 'modal-body' }, props.children),
        props.footer && h('div', { className: 'modal-footer' }, props.footer)
      )
    );
  }

  // ── LOGIN ──────────────────────────────────────────────────────────
  function LoginPage() {
    var auth = useAuth();
    var _e = useState(''); var email = _e[0]; var setEmail = _e[1];
    var _p = useState(''); var pass = _p[0]; var setPass = _p[1];
    var _err = useState(''); var err = _err[0]; var setErr = _err[1];
    var _b = useState(false); var busy = _b[0]; var setBusy = _b[1];

    async function submit(e) {
      e.preventDefault();
      setBusy(true); setErr('');
      var res = await auth.signIn(email, pass);
      if (res.error) {
        var msg = res.error.toLowerCase().indexOf('invalid') >= 0 ? 'Email ou senha incorretos.' : res.error;
        setErr(msg);
        setBusy(false);
      }
      // on success: auth state changes, component unmounts
    }

    return h('div', { className: 'login-wrap' },
      h('div', { className: 'login-card animate-in' },
        h('div', { className: 'login-icon' }, h(Icon, { name: 'Package', size: 24, color: '#FAF7F2' })),
        h('h1', { className: 'login-title' }, 'Castellar Móbile'),
        h('p', { className: 'login-sub' }, 'Gestão de Estoque'),
        h('form', { onSubmit: submit },
          h('div', { className: 'form-group' },
            h('label', { className: 'label' }, 'Email'),
            h('input', { className: 'input', type: 'email', placeholder: 'seu@email.com', value: email, onChange: function(e) { setEmail(e.target.value); }, required: true, autoComplete: 'email' })
          ),
          h('div', { className: 'form-group' },
            h('label', { className: 'label' }, 'Senha'),
            h('input', { className: 'input', type: 'password', placeholder: '••••••••', value: pass, onChange: function(e) { setPass(e.target.value); }, required: true, autoComplete: 'current-password' })
          ),
          err && h('div', { className: 'error-msg' }, err),
          h('button', { className: 'btn btn-primary btn-full', type: 'submit', disabled: busy, style: { justifyContent: 'center' } },
            busy ? 'Entrando...' : 'Entrar'
          )
        )
      )
    );
  }

  // ── PENDING ────────────────────────────────────────────────────────
  function PendingPage() {
    var auth = useAuth();
    var _b = useState(false); var busy = _b[0]; var setBusy = _b[1];
    async function check() {
      setBusy(true); await auth.refreshRole(); setBusy(false);
    }
    return h('div', { className: 'pending-wrap' },
      h('div', { className: 'pending-card animate-in' },
        h('div', { className: 'pending-icon' }, h(Icon, { name: 'Lock', size: 28 })),
        h('h2', { className: 'pending-title' }, 'Acesso Pendente'),
        h('p', { className: 'pending-sub' }, 'Seu acesso ainda não foi configurado. Peça ao gestor para atribuir seu papel.'),
        h('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center', marginTop: '20px', flexWrap: 'wrap' } },
          h('button', { className: 'btn btn-primary btn-sm', onClick: check, disabled: busy, style: { display: 'inline-flex', alignItems: 'center', gap: '6px' } },
            h(Icon, { name: 'Refresh', size: 14 }), busy ? 'Verificando...' : 'Verificar acesso'
          ),
          h('button', { className: 'btn btn-outline btn-sm', onClick: auth.signOut, style: { display: 'inline-flex', alignItems: 'center', gap: '6px' } },
            h(Icon, { name: 'LogOut', size: 14 }), 'Sair'
          )
        ),
        h('div', { className: 'pending-id' }, 'ID: ' + (auth.user ? auth.user.id : ''))
      )
    );
  }

  // ── PRODUCTS ───────────────────────────────────────────────────────
  var CAT = { sofa: 'Sofá', poltrona: 'Poltrona', recamier: 'Recamier', puff: 'Puff' };
  var COND = { novo: 'Novo', leves_defeitos: 'Leves Defeitos', assistencia: 'Assistência' };

  function ProductsPage(props) {
    var goTo = props.goTo;
    var auth = useAuth();
    var canEdit = auth.role === 'gestor' || auth.role === 'editor';
    var _p = useState([]); var products = _p[0]; var setProducts = _p[1];
    var _b = useState({}); var balances = _b[0]; var setBalances = _b[1];
    var _l = useState(true); var loading = _l[0]; var setLoading = _l[1];
    var _m = useState(null); var mov = _m[0]; var setMov = _m[1];
    var _q = useState('1'); var qty = _q[0]; var setQty = _q[1];
    var _s = useState(false); var busy = _s[0]; var setBusy = _s[1];

    async function load() {
      var r1 = await sb.from('products').select('*').order('name');
      var r2 = await sb.from('stock_movements').select('product_id,type,quantity');
      setProducts(r1.data || []);
      var b = {};
      (r2.data || []).forEach(function(m) {
        b[m.product_id] = (b[m.product_id] || 0) + (m.type === 'entrada' ? m.quantity : -m.quantity);
      });
      setBalances(b);
      setLoading(false);
    }
    useEffect(function() { load(); }, []);

    async function doMov() {
      var n = parseInt(qty);
      if (!n || n <= 0) { toast('Quantidade inválida', 'error'); return; }
      setBusy(true);
      var res = await sb.from('stock_movements').insert({ product_id: mov.product.id, type: mov.type, quantity: n, user_id: auth.user.id });
      setBusy(false);
      if (res.error) { toast('Erro: ' + res.error.message, 'error'); return; }
      toast(mov.type === 'entrada' ? '✓ Entrada registrada!' : '✓ Saída registrada!', 'success');
      setMov(null); setQty('1');
      var r2 = await sb.from('stock_movements').select('product_id,type,quantity');
      var b = {};
      (r2.data || []).forEach(function(m) {
        b[m.product_id] = (b[m.product_id] || 0) + (m.type === 'entrada' ? m.quantity : -m.quantity);
      });
      setBalances(b);
    }

    if (loading) return h('div', { className: 'loading' }, 'Carregando produtos...');

    return h('div', { className: 'animate-in' },
      h('div', { className: 'page-header' },
        h('h1', { className: 'page-title' }, 'Produtos'),
        canEdit && h('button', { className: 'btn btn-primary btn-sm', onClick: function() { goTo('new-product'); }, style: { display: 'inline-flex', alignItems: 'center', gap: '6px' } },
          h(Icon, { name: 'Plus', size: 14 }), 'Novo'
        )
      ),
      products.length === 0
        ? h('div', { className: 'card card-dashed' }, h('div', { className: 'empty-state' },
            h(Icon, { name: 'Box', size: 48 }),
            h('p', null, 'Nenhum produto cadastrado'),
            canEdit && h('button', { className: 'btn btn-outline btn-sm', style: { marginTop: '4px' }, onClick: function() { goTo('new-product'); } }, 'Cadastrar primeiro produto')
          ))
        : h('div', { className: 'space-y' },
            products.map(function(p) {
              var stock = balances[p.id] || 0;
              return h('div', { key: p.id, className: 'card' },
                h('div', { className: 'card-body' },
                  h('div', { style: { display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', gap: '8px' } },
                    h('div', { style: { flex: 1, minWidth: 0 } },
                      h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' } },
                        h('span', { style: { fontWeight: 600, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, p.name),
                        h('span', { className: 'badge badge-secondary' }, CAT[p.category] || p.category)
                      ),
                      h('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '0 12px', marginTop: '4px', fontSize: '0.75rem', color: 'var(--text3)' } },
                        p.fabric && h('span', null, 'Tecido: ' + p.fabric),
                        p.size && h('span', null, 'Tam: ' + p.size),
                        h('span', null, COND[p.condition] || p.condition)
                      )
                    ),
                    h('div', { style: { textAlign: 'right', flexShrink: 0 } },
                      h('div', { className: 'product-stock', style: { color: stock <= 0 ? 'var(--saida)' : 'var(--text)' } }, stock),
                      h('div', { style: { fontSize: '0.72rem', color: 'var(--text3)' } }, 'em estoque')
                    )
                  ),
                  canEdit && h('div', { style: { display: 'flex', gap: '8px', marginTop: '12px' } },
                    h('button', { className: 'mov-btn mov-btn-e', onClick: function() { setMov({ product: p, type: 'entrada' }); } }, h(Icon, { name: 'Plus', size: 14 }), 'Entrada'),
                    h('button', { className: 'mov-btn mov-btn-s', onClick: function() { setMov({ product: p, type: 'saida' }); } }, h(Icon, { name: 'Minus', size: 14 }), 'Saída')
                  )
                )
              );
            })
          ),
      h(Modal, {
        open: !!mov, onClose: function() { setMov(null); setQty('1'); },
        title: mov && mov.type === 'entrada' ? 'Dar Entrada' : 'Dar Saída',
        footer: h(Fragment, null,
          h('button', { className: 'btn btn-outline', onClick: function() { setMov(null); } }, 'Cancelar'),
          h('button', { className: 'btn ' + (mov && mov.type === 'entrada' ? 'btn-primary' : 'btn-danger'), onClick: doMov, disabled: busy }, busy ? 'Registrando...' : 'Confirmar')
        )
      },
        h('p', { style: { fontSize: '0.875rem', marginBottom: '12px' } }, 'Produto: ', h('strong', null, mov && mov.product ? mov.product.name : '')),
        h('label', { className: 'label' }, 'Quantidade'),
        h('input', { className: 'input', type: 'number', min: 1, value: qty, onChange: function(e) { setQty(e.target.value); }, autoFocus: true })
      )
    );
  }

  // ── NEW PRODUCT ────────────────────────────────────────────────────
  function NewProductPage(props) {
    var goTo = props.goTo;
    var _f = useState({ name: '', category: '', size: '', fabric: '', condition: 'novo' });
    var f = _f[0]; var setF = _f[1];
    var _b = useState(false); var busy = _b[0]; var setBusy = _b[1];

    async function submit(e) {
      e.preventDefault();
      if (!f.name || !f.category) { toast('Preencha nome e categoria', 'error'); return; }
      setBusy(true);
      var res = await sb.from('products').insert({ name: f.name, category: f.category, size: f.size || null, fabric: f.fabric || null, condition: f.condition });
      setBusy(false);
      if (res.error) { toast('Erro: ' + res.error.message, 'error'); return; }
      toast('✓ Produto cadastrado!', 'success');
      goTo('products');
    }

    return h('div', { className: 'animate-in' },
      h('button', { className: 'back-btn', onClick: function() { goTo('products'); } }, h(Icon, { name: 'ArrowLeft', size: 15 }), ' Voltar'),
      h('div', { className: 'card' },
        h('div', { className: 'card-body' },
          h('h2', { className: 'page-title', style: { marginBottom: '1.25rem' } }, 'Cadastrar Produto'),
          h('form', { onSubmit: submit },
            h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Nome do Produto *'), h('input', { className: 'input', value: f.name, onChange: function(e) { setF(Object.assign({}, f, { name: e.target.value })); }, placeholder: 'Ex: Sofá Milano 3 Lugares', required: true })),
            h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Categoria *'),
              h('select', { className: 'select', value: f.category, onChange: function(e) { setF(Object.assign({}, f, { category: e.target.value })); }, required: true },
                h('option', { value: '' }, 'Selecione'),
                h('option', { value: 'sofa' }, 'Sofá'),
                h('option', { value: 'poltrona' }, 'Poltrona'),
                h('option', { value: 'recamier' }, 'Recamier'),
                h('option', { value: 'puff' }, 'Puff')
              )
            ),
            h('div', { className: 'form-grid' },
              h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Tamanho'), h('input', { className: 'input', value: f.size, onChange: function(e) { setF(Object.assign({}, f, { size: e.target.value })); }, placeholder: 'Ex: 2.20m' })),
              h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Tecido'), h('input', { className: 'input', value: f.fabric, onChange: function(e) { setF(Object.assign({}, f, { fabric: e.target.value })); }, placeholder: 'Ex: Linho' }))
            ),
            h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Condição'),
              h('select', { className: 'select', value: f.condition, onChange: function(e) { setF(Object.assign({}, f, { condition: e.target.value })); } },
                h('option', { value: 'novo' }, 'Novo'),
                h('option', { value: 'leves_defeitos' }, 'Leves Defeitos'),
                h('option', { value: 'assistencia' }, 'Assistência')
              )
            ),
            h('button', { className: 'btn btn-primary btn-full', type: 'submit', disabled: busy, style: { justifyContent: 'center' } }, busy ? 'Cadastrando...' : 'Cadastrar Produto')
          )
        )
      )
    );
  }

  // ── REPORTS ────────────────────────────────────────────────────────
  function ReportsPage() {
    var _m = useState([]); var movs = _m[0]; var setMovs = _m[1];
    var _l = useState(true); var loading = _l[0]; var setLoading = _l[1];
    var _f = useState(''); var from = _f[0]; var setFrom = _f[1];
    var _t = useState(''); var to = _t[0]; var setTo = _t[1];

    async function load() {
      setLoading(true);
      var q = sb.from('stock_movements').select('id,type,quantity,created_at,product_id,user_id').order('created_at', { ascending: false });
      if (from) q = q.gte('created_at', from + 'T00:00:00');
      if (to) q = q.lte('created_at', to + 'T23:59:59');
      var res = await q;
      var data = res.data;
      if (!data || !data.length) { setMovs([]); setLoading(false); return; }
      var pids = [...new Set(data.map(function(m) { return m.product_id; }))];
      var uids = [...new Set(data.map(function(m) { return m.user_id; }))];
      var r1 = await sb.from('products').select('id,name,category').in('id', pids);
      var r2 = await sb.from('profiles').select('user_id,full_name').in('user_id', uids);
      var pm = new Map((r1.data || []).map(function(p) { return [p.id, p]; }));
      var um = new Map((r2.data || []).map(function(p) { return [p.user_id, p.full_name]; }));
      setMovs(data.map(function(m) {
        var prod = pm.get(m.product_id);
        return Object.assign({}, m, { pname: prod ? prod.name : '—', pcat: prod ? prod.category : '', uname: um.get(m.user_id) || '—' });
      }));
      setLoading(false);
    }
    useEffect(function() { load(); }, [from, to]);

    var ent = movs.filter(function(m) { return m.type === 'entrada'; }).reduce(function(s, m) { return s + m.quantity; }, 0);
    var sai = movs.filter(function(m) { return m.type === 'saida'; }).reduce(function(s, m) { return s + m.quantity; }, 0);
    function fmt(iso) {
      var d = new Date(iso);
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' }) + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    return h('div', { className: 'animate-in' },
      h('h1', { className: 'page-title', style: { marginBottom: '1rem' } }, 'Relatórios'),
      h('div', { className: 'card', style: { marginBottom: '12px' } },
        h('div', { className: 'card-body' },
          h('div', { className: 'form-grid' },
            h('div', null, h('label', { className: 'label' }, 'Data Início'), h('input', { className: 'input', type: 'date', value: from, onChange: function(e) { setFrom(e.target.value); } })),
            h('div', null, h('label', { className: 'label' }, 'Data Fim'), h('input', { className: 'input', type: 'date', value: to, onChange: function(e) { setTo(e.target.value); } }))
          )
        )
      ),
      h('div', { className: 'form-grid', style: { marginBottom: '12px' } },
        h('div', { className: 'card' }, h('div', { className: 'stat-card' },
          h('div', { className: 'stat-icon', style: { background: 'rgba(45,106,79,0.12)', color: 'var(--entrada)' } }, h(Icon, { name: 'ArrowDown', size: 22 })),
          h('div', null, h('div', { className: 'stat-label' }, 'Entradas'), h('div', { className: 'stat-value', style: { color: 'var(--entrada)' } }, ent))
        )),
        h('div', { className: 'card' }, h('div', { className: 'stat-card' },
          h('div', { className: 'stat-icon', style: { background: 'rgba(192,57,43,0.12)', color: 'var(--saida)' } }, h(Icon, { name: 'ArrowUp', size: 22 })),
          h('div', null, h('div', { className: 'stat-label' }, 'Saídas'), h('div', { className: 'stat-value', style: { color: 'var(--saida)' } }, sai))
        ))
      ),
      loading ? h('div', { className: 'loading' }, 'Carregando...')
      : movs.length === 0
        ? h('div', { className: 'card card-dashed' }, h('div', { className: 'empty-state' }, h(Icon, { name: 'BarChart', size: 48 }), h('p', null, 'Nenhuma movimentação encontrada')))
        : h('div', { className: 'card' },
            movs.map(function(m) {
              return h('div', { key: m.id, className: 'mov-row' },
                h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '8px' } },
                  h('div', { style: { flex: 1, minWidth: 0 } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                      h('span', { className: 'badge ' + (m.type === 'entrada' ? 'badge-entrada' : 'badge-saida') }, (m.type === 'entrada' ? '+' : '−') + m.quantity),
                      h('span', { style: { fontWeight: 600, fontSize: '0.875rem', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, m.pname)
                    ),
                    h('div', { style: { display: 'flex', gap: '6px', marginTop: '4px', fontSize: '0.72rem', color: 'var(--text3)', alignItems: 'center' } },
                      h(Icon, { name: 'Clock', size: 11 }), h('span', null, m.uname), h('span', null, '·'), h('span', null, fmt(m.created_at))
                    )
                  ),
                  h('span', { className: 'badge badge-secondary', style: { flexShrink: 0 } }, CAT[m.pcat] || m.pcat)
                )
              );
            })
          )
    );
  }

  // ── USERS ──────────────────────────────────────────────────────────
  function UsersPage() {
    var auth = useAuth();
    var _u = useState([]); var users = _u[0]; var setUsers = _u[1];
    var _l = useState(true); var loading = _l[0]; var setLoading = _l[1];
    var _sc = useState(false); var showCreate = _sc[0]; var setShowCreate = _sc[1];
    var _cr = useState(false); var creating = _cr[0]; var setCreating = _cr[1];
    var _eu = useState(null); var editUser = _eu[0]; var setEditUser = _eu[1];
    var _er = useState('visualizador'); var editRole = _er[0]; var setEditRole = _er[1];
    var _sv = useState(false); var saving = _sv[0]; var setSaving = _sv[1];
    var _nu = useState({ email: '', password: '', fullName: '', role: 'visualizador' });
    var nu = _nu[0]; var setNu = _nu[1];

    async function load() {
      var r1 = await sb.from('profiles').select('user_id,full_name');
      var r2 = await sb.from('user_roles').select('user_id,role');
      var rm = new Map((r2.data || []).map(function(r) { return [r.user_id, r.role]; }));
      setUsers((r1.data || []).map(function(p) { return Object.assign({}, p, { role: rm.get(p.user_id) || null }); }));
      setLoading(false);
    }
    useEffect(function() { load(); }, []);

    async function create() {
      if (!nu.email || !nu.password || !nu.fullName) { toast('Preencha todos os campos', 'error'); return; }
      if (nu.password.length < 6) { toast('Senha deve ter no mínimo 6 caracteres', 'error'); return; }
      setCreating(true);
      var res = await sb.auth.signUp({ email: nu.email, password: nu.password, options: { data: { full_name: nu.fullName } } });
      if (res.error || !res.data.user) { toast(res.error ? res.error.message : 'Erro ao criar usuário', 'error'); setCreating(false); return; }
      await sb.from('user_roles').insert({ user_id: res.data.user.id, role: nu.role });
      toast('✓ Usuário criado!', 'success');
      setShowCreate(false); setNu({ email: '', password: '', fullName: '', role: 'visualizador' });
      setCreating(false); load();
    }

    async function saveRole() {
      if (!editUser) return;
      setSaving(true);
      await sb.from('user_roles').upsert({ user_id: editUser.user_id, role: editRole }, { onConflict: 'user_id' });
      setSaving(false);
      toast('✓ Papel atualizado!', 'success'); setEditUser(null); load();
    }

    var RBADGE = { gestor: 'badge-gestor', editor: 'badge-editor', visualizador: 'badge-visualizador' };
    function rl(r) { return r ? r[0].toUpperCase() + r.slice(1) : 'Sem papel'; }

    return h('div', { className: 'animate-in' },
      h('div', { className: 'page-header' },
        h('h1', { className: 'page-title' }, 'Usuários'),
        h('button', { className: 'btn btn-primary btn-sm', onClick: function() { setShowCreate(true); }, style: { display: 'inline-flex', alignItems: 'center', gap: '6px' } }, h(Icon, { name: 'UserPlus', size: 14 }), 'Novo')
      ),
      loading ? h('div', { className: 'loading' }, 'Carregando...')
      : users.length === 0
        ? h('div', { className: 'card card-dashed' }, h('div', { className: 'empty-state' }, h(Icon, { name: 'Users', size: 48 }), h('p', null, 'Nenhum usuário')))
        : h('div', { className: 'card' },
            users.map(function(u) {
              return h('div', { key: u.user_id, className: 'mov-row' },
                h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
                  h('div', null,
                    h('div', { style: { fontWeight: 600, fontSize: '0.875rem' } }, u.full_name),
                    u.user_id === (auth.user ? auth.user.id : '') && h('div', { style: { fontSize: '0.72rem', color: 'var(--text3)' } }, 'Você')
                  ),
                  h('div', { style: { display: 'flex', alignItems: 'center', gap: '8px' } },
                    h('span', { className: 'badge ' + (RBADGE[u.role] || 'badge-sem') }, rl(u.role)),
                    u.user_id !== (auth.user ? auth.user.id : '') && h('button', { className: 'btn btn-outline btn-sm', onClick: function() { setEditUser(u); setEditRole(u.role || 'visualizador'); } }, 'Editar')
                  )
                )
              );
            })
          ),
      h(Modal, {
        open: showCreate, onClose: function() { setShowCreate(false); }, title: 'Criar Novo Usuário',
        footer: h(Fragment, null,
          h('button', { className: 'btn btn-outline', onClick: function() { setShowCreate(false); } }, 'Cancelar'),
          h('button', { className: 'btn btn-primary', onClick: create, disabled: creating }, creating ? 'Criando...' : 'Criar Usuário')
        )
      },
        h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Nome Completo'), h('input', { className: 'input', value: nu.fullName, onChange: function(e) { setNu(Object.assign({}, nu, { fullName: e.target.value })); }, placeholder: 'Nome do colaborador' })),
        h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Email'), h('input', { className: 'input', type: 'email', value: nu.email, onChange: function(e) { setNu(Object.assign({}, nu, { email: e.target.value })); }, placeholder: 'email@exemplo.com' })),
        h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Senha'), h('input', { className: 'input', type: 'password', value: nu.password, onChange: function(e) { setNu(Object.assign({}, nu, { password: e.target.value })); }, placeholder: 'Mínimo 6 caracteres' })),
        h('div', { className: 'form-group' }, h('label', { className: 'label' }, 'Papel'),
          h('select', { className: 'select', value: nu.role, onChange: function(e) { setNu(Object.assign({}, nu, { role: e.target.value })); } },
            h('option', { value: 'gestor' }, 'Gestor'),
            h('option', { value: 'editor' }, 'Editor'),
            h('option', { value: 'visualizador' }, 'Visualizador')
          )
        )
      ),
      h(Modal, {
        open: !!editUser, onClose: function() { setEditUser(null); }, title: 'Editar Papel',
        footer: h(Fragment, null,
          h('button', { className: 'btn btn-outline', onClick: function() { setEditUser(null); } }, 'Cancelar'),
          h('button', { className: 'btn btn-primary', onClick: saveRole, disabled: saving }, saving ? 'Salvando...' : 'Salvar')
        )
      },
        h('p', { style: { fontSize: '0.875rem', marginBottom: '12px' } }, 'Usuário: ', h('strong', null, editUser ? editUser.full_name : '')),
        h('label', { className: 'label' }, 'Papel'),
        h('select', { className: 'select', value: editRole, onChange: function(e) { setEditRole(e.target.value); } },
          h('option', { value: 'gestor' }, 'Gestor'),
          h('option', { value: 'editor' }, 'Editor'),
          h('option', { value: 'visualizador' }, 'Visualizador')
        )
      )
    );
  }

  // ── LAYOUT ─────────────────────────────────────────────────────────
  function AppLayout(props) {
    var page = props.page, goTo = props.goTo, role = props.role, profileName = props.profileName, signOut = props.signOut;
    var nav = [
      { id: 'products', label: 'Produtos', icon: 'Box' },
      { id: 'reports', label: 'Relatórios', icon: 'BarChart' }
    ];
    if (role === 'gestor') nav.push({ id: 'users', label: 'Usuários', icon: 'Users' });

    return h('div', { className: 'app-shell' },
      h('header', { className: 'topbar' },
        h('div', { className: 'logo' },
          h('div', { className: 'logo-icon' }, h(Icon, { name: 'Package', size: 20, color: '#FAF7F2' })),
          h('span', { className: 'logo-name' }, 'Castellar')
        ),
        (role === 'gestor' || role === 'editor') && page === 'products' &&
          h('button', { className: 'btn btn-primary btn-sm', onClick: function() { goTo('new-product'); }, style: { display: 'inline-flex', alignItems: 'center', gap: '6px' } }, h(Icon, { name: 'Plus', size: 14 }), 'Produto')
      ),
      h('div', { className: 'body-area' },
        h('aside', { className: 'sidebar' },
          nav.map(function(item) {
            return h('button', { key: item.id, className: 'sidebar-item' + (page === item.id ? ' active' : ''), onClick: function() { goTo(item.id); } }, h(Icon, { name: item.icon, size: 17 }), item.label);
          }),
          h('div', { className: 'sidebar-spacer' }),
          h('div', { className: 'sidebar-user' },
            h('div', { className: 'sidebar-user-name' }, profileName || '—'),
            h('div', { className: 'sidebar-user-role' }, role || ''),
            h('button', { className: 'sidebar-item danger', onClick: signOut }, h(Icon, { name: 'LogOut', size: 16 }), 'Sair')
          )
        ),
        h('main', { className: 'main' }, props.children)
      ),
      h('nav', { className: 'bottom-nav' },
        nav.map(function(item) {
          return h('button', { key: item.id, className: 'bottom-nav-item' + (page === item.id ? ' active' : ''), onClick: function() { goTo(item.id); } },
            h(Icon, { name: item.icon, size: 22 }), h('span', null, item.label)
          );
        })
      )
    );
  }

  // ── ROUTER ─────────────────────────────────────────────────────────
  function AppRouter() {
    var auth = useAuth();
    var _pg = useState('products'); var page = _pg[0]; var setPage = _pg[1];
    function goTo(p) { setPage(p); window.scrollTo(0, 0); }

    if (auth.user === undefined) return h('div', { className: 'loading', style: { paddingTop: '40vh' } }, 'Carregando...');
    if (!auth.user) return h(LoginPage);
    if (!auth.role) return h(PendingPage);

    var canEdit = auth.role === 'gestor' || auth.role === 'editor';
    var content;
    if (page === 'new-product' && canEdit) content = h(NewProductPage, { goTo: goTo });
    else if (page === 'reports') content = h(ReportsPage);
    else if (page === 'users' && auth.role === 'gestor') content = h(UsersPage);
    else content = h(ProductsPage, { goTo: goTo });

    return h(AppLayout, { page: page, goTo: goTo, role: auth.role, profileName: auth.profileName, signOut: auth.signOut }, content);
  }

  createRoot(document.getElementById('root')).render(
    h(AuthProvider, null, h(AppRouter))
  );
}
</script>
</body>
</html>
